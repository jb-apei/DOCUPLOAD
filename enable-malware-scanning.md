# Enable Malware Scanning in Azure Portal - Step-by-Step Guide

## ‚úÖ Good News
Defender for Storage is already enabled at subscription level!
```
Tier: Standard
SubPlan: DefenderForStorageV2
```

## üéØ Direct Portal Link

**Open this URL directly:**
```
https://portal.azure.com/#@3f59ba70-530a-4800-be1b-f5b04e0e15f7/resource/subscriptions/e108977f-44ed-4400-9580-f7a0bc1d3630/resourceGroups/rg-rfpo-e108977f/providers/Microsoft.Storage/storageAccounts/strfpo5kn5bsg47vvac/security
```

## üìç Portal Navigation Steps

### Option 1: Via Storage Account (RECOMMENDED)
1. Go to Azure Portal: https://portal.azure.com
2. Search for "strfpo5kn5bsg47vvac" (your storage account)
3. Click on the storage account
4. In the left sidebar, scroll down to **"Security + networking"** section
5. Click **"Microsoft Defender for Cloud"** (or just **"Security"**)
6. You should see:
   - **Defender for Storage status**: ON (already enabled)
   - **Malware Scanning**: This is what you need to toggle ON

### Option 2: Via Defender for Cloud
1. Go to Azure Portal: https://portal.azure.com
2. Search for "Microsoft Defender for Cloud"
3. Click **"Environment settings"** in left sidebar
4. Expand your subscription tree
5. Find and click on storage account **"strfpo5kn5bsg47vvac"**
6. You should see settings for:
   - Activity monitoring: ON
   - **Malware Scanning**: Toggle this ON
   - Sensitive data threat detection: ON/OFF

### Option 3: Via Storage Account - Settings
1. Go to storage account: strfpo5kn5bsg47vvac
2. Left sidebar ‚Üí **"Settings"** section
3. Look for **"Configuration"** or **"Advanced security"**
4. Some Azure deployments show it under **"Properties"** ‚Üí **"Blob service"** ‚Üí **"Advanced security"**

## üîß Alternative: Enable via Azure CLI/PowerShell

Unfortunately, malware scanning settings are not yet fully exposed via Azure CLI. However, you can use Azure REST API:

```powershell
# Get the storage account resource ID
$storageAccountId = "/subscriptions/e108977f-44ed-4400-9580-f7a0bc1d3630/resourceGroups/rg-rfpo-e108977f/providers/Microsoft.Storage/storageAccounts/strfpo5kn5bsg47vvac"

# Enable malware scanning via REST API
$body = @{
    properties = @{
        isEnabled = $true
        capGBPerMonth = 5000
    }
} | ConvertTo-Json

az rest --method PUT `
    --url "https://management.azure.com${storageAccountId}/providers/Microsoft.Security/defenderForStorageSettings/current?api-version=2022-12-01-preview" `
    --body $body
```

## üîç What to Look For

When you find the right page, you should see:

**Microsoft Defender for Storage**
- ‚úÖ Status: Protected (or ON)
- ‚öôÔ∏è **Malware Scanning**: OFF ‚Üí Toggle to **ON**
  - Cap: 5000 GB per month (default)
  - Price: ~$0.15 per GB scanned

**After enabling:**
- Click **"Save"**
- Wait 5-10 minutes for provisioning

## ‚úÖ Verify It's Working

After enabling, test with this command:

```powershell
# Upload a test file and check tags
az storage blob upload `
    --account-name strfpo5kn5bsg47vvac `
    --container-name usabc-uploads-stage `
    --name "test-scan.txt" `
    --file "test-scan.txt" `
    --auth-mode login

# Wait 30 seconds, then check for scan result tags
az storage blob tag list `
    --account-name strfpo5kn5bsg47vvac `
    --container-name usabc-uploads-stage `
    --name "test-scan.txt" `
    --auth-mode login
```

Look for tags:
- `Malware Scanning scan result`: "No threats found" or "Malicious"
- `Malware Scanning scan time UTC`: Timestamp

## üÜò Still Can't Find It?

If the Malware Scanning option is not visible:

1. **Check your Azure role**: You need "Security Admin" or "Contributor" role
2. **Check subscription**: Ensure Defender for Storage V2 is enabled (it is ‚úÖ)
3. **Portal cache**: Try incognito/private browsing mode
4. **UI rollout**: The feature might still be rolling out in your region

### Workaround: Deploy via ARM Template

If the portal UI is not showing the option, you can force-enable it via ARM template:

```powershell
# Create ARM template file
$template = @'
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "resources": [
    {
      "type": "Microsoft.Security/defenderForStorageSettings",
      "apiVersion": "2022-12-01-preview",
      "name": "current",
      "scope": "[resourceId('Microsoft.Storage/storageAccounts', 'strfpo5kn5bsg47vvac')]",
      "properties": {
        "isEnabled": true,
        "malwareScanning": {
          "onUpload": {
            "isEnabled": true,
            "capGBPerMonth": 5000
          }
        },
        "sensitiveDataDiscovery": {
          "isEnabled": false
        }
      }
    }
  ]
}
'@

$template | Out-File -FilePath "defender-malware.json"

# Deploy the template
az deployment group create `
    --resource-group rg-rfpo-e108977f `
    --template-file defender-malware.json
```

## üìû Need Help?

If you're still stuck, let me know and we can:
1. Try the ARM template deployment method above
2. Check if your subscription/region has the feature available
3. Use ClamAV as a fallback (already in code)
